{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="page-header">
  <h2>System Settings</h2>
</div>

<!-- System Settings -->
<div class="card">
  <div class="card-header"><h3>Operational Parameters</h3></div>
  <form method="POST">
    <input type="hidden" name="form_type" value="system">
    <div class="form-row-3">
      <div class="form-group">
        <label>Potency Rate ($/lb/%pt)</label>
        <input type="number" name="potency_rate" value="{{ system_settings.get('potency_rate', '1.50') }}" step="0.01">
      </div>
      <div class="form-group">
        <label>Number of Reactors</label>
        <input type="number" name="num_reactors" value="{{ system_settings.get('num_reactors', '2') }}">
      </div>
      <div class="form-group">
        <label>Reactor Capacity (lbs)</label>
        <input type="number" name="reactor_capacity" value="{{ system_settings.get('reactor_capacity', '100') }}">
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label>Runs Per Day Target</label>
        <input type="number" name="runs_per_day" value="{{ system_settings.get('runs_per_day', '5') }}">
      </div>
      <div class="form-group">
        <label>Operating Days/Week</label>
        <input type="number" name="operating_days" value="{{ system_settings.get('operating_days', '7') }}">
      </div>
      <div class="form-group">
        <label>Daily Throughput Target (lbs)</label>
        <input type="number" name="daily_throughput_target" value="{{ system_settings.get('daily_throughput_target', '500') }}">
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label>Weekly Throughput Target (lbs)</label>
        <input type="number" name="weekly_throughput_target" value="{{ system_settings.get('weekly_throughput_target', '3500') }}">
      </div>
    </div>
    <div class="form-group" style="margin-top:8px;">
      <label style="display:flex;align-items:center;gap:8px; text-transform:none; letter-spacing:0; font-size:0.85rem; color:var(--text-secondary);">
        <input type="checkbox" name="exclude_unpriced_batches" {% if system_settings.get('exclude_unpriced_batches', '0') in ('1','true','yes','on') %}checked{% endif %}>
        Exclude runs missing biomass pricing ($/lb) from yield + cost analytics
      </label>
      <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
        When enabled, Dashboard/Supplier/Strain KPIs ignore runs that are unlinked or have any input lot without a Purchase price.
      </div>
    </div>
    <div class="form-group" style="margin-top:10px;">
      <label>Cost Allocation Method (THCA vs HTE)</label>
      {% set method = system_settings.get('cost_allocation_method', 'per_gram_uniform') %}
      <select name="cost_allocation_method">
        <option value="per_gram_uniform" {% if method == 'per_gram_uniform' %}selected{% endif %}>
          Uniform $/g across all dry grams (THCA and HTE match)
        </option>
        <option value="split_50_50" {% if method == 'split_50_50' %}selected{% endif %}>
          Split total run cost 50/50 between THCA and HTE (lower yield → higher $/g)
        </option>
        <option value="custom_split" {% if method == 'custom_split' %}selected{% endif %}>
          Custom split of total run cost (set THCA % below)
        </option>
      </select>
      <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
        This impacts <strong>Cost/Gram THCA</strong> and <strong>Cost/Gram HTE</strong>. Combined $/g is always total cost ÷ total dry grams.
      </div>
    </div>
    <div class="form-row-3" style="margin-top:8px;">
      <div class="form-group">
        <label>Custom split — THCA % of total cost</label>
        <input type="number" name="cost_allocation_thca_pct" value="{{ system_settings.get('cost_allocation_thca_pct', '50') }}" step="0.1" min="0" max="100">
        <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
          Used only when “Custom split” is selected. HTE gets the remainder \(100 - \text{THCA%}\).
        </div>
      </div>
      <div class="form-group"></div>
      <div class="form-group"></div>
    </div>
    <div class="form-actions" style="border:none;padding:0;margin:0;">
      <button type="submit" class="btn btn-primary">Save Settings</button>
    </div>
  </form>
</div>

<!-- KPI Targets -->
<div class="card">
  <div class="card-header"><h3>KPI Targets</h3></div>
  <form method="POST">
    <input type="hidden" name="form_type" value="kpi">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>KPI</th>
            <th>Direction</th>
            <th>Unit</th>
            <th class="text-right">Target</th>
            <th class="text-right">Green Threshold</th>
            <th class="text-right">Yellow Threshold</th>
          </tr>
        </thead>
        <tbody>
          {% for kpi in kpis %}
          <tr>
            <input type="hidden" name="kpi_ids[]" value="{{ kpi.id }}">
            <td><strong>{{ kpi.display_name }}</strong></td>
            <td><span class="badge badge-gray">{{ kpi.direction.replace('_', ' ') }}</span></td>
            <td>{{ kpi.unit }}</td>
            <td class="text-right">
              <input type="number" name="target_{{ kpi.id }}" value="{{ kpi.target_value }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--text-primary);text-align:right;font-family:var(--font-mono);">
            </td>
            <td class="text-right">
              <input type="number" name="green_{{ kpi.id }}" value="{{ kpi.green_threshold }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--green);text-align:right;font-family:var(--font-mono);">
            </td>
            <td class="text-right">
              <input type="number" name="yellow_{{ kpi.id }}" value="{{ kpi.yellow_threshold }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--yellow);text-align:right;font-family:var(--font-mono);">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="form-actions" style="border:none;padding-top:12px;margin:0;">
      <button type="submit" class="btn btn-primary">Save KPI Targets</button>
    </div>
  </form>
</div>

<!-- User Management -->
<div class="card">
  <div class="card-header"><h3>Users</h3></div>
  <div class="table-wrap mb-2">
    <table>
      <thead>
        <tr><th>Username</th><th>Display Name</th><th>Role</th><th>Status</th><th>Created</th><th></th></tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.display_name }}</td>
          <td><span class="badge badge-gold">{{ u.role.replace('_', ' ') }}</span></td>
          <td>
            {% if u.is_active_user %}
              <span class="badge badge-green">Active</span>
            {% else %}
              <span class="badge badge-gray">Disabled</span>
            {% endif %}
          </td>
          <td>{{ u.created_at.strftime('%m/%d/%y') if u.created_at else '—' }}</td>
          <td style="white-space:nowrap;">
            {% if u.id == current_user.id %}
              <span class="text-sm" style="color:var(--text-muted);">Current</span>
            {% else %}
              <form method="POST" action="{{ url_for('user_toggle_active', user_id=u.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure? This will {{ 'disable' if u.is_active_user else 'activate' }} the user account.');">
                {% if u.is_active_user %}
                  <button type="submit" class="btn btn-danger btn-sm">Disable</button>
                {% else %}
                  <button type="submit" class="btn btn-secondary btn-sm">Activate</button>
                {% endif %}
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form method="POST">
    <input type="hidden" name="form_type" value="user">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:16px 0 12px;">Add New User</h4>
    <div class="form-row-3">
      <div class="form-group">
        <label>Username</label>
        <input type="text" name="new_username" placeholder="lowercase, no spaces">
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" name="new_display" placeholder="Full name">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select name="new_role">
          <option value="viewer">Viewer (read only)</option>
          <option value="user">User (can edit data)</option>
          <option value="super_admin">Super Admin (full access)</option>
        </select>
      </div>
    </div>
    <div class="form-group" style="max-width:300px;">
      <label>Password</label>
      <input type="password" name="new_password" placeholder="Min 8 characters">
    </div>
    <button type="submit" class="btn btn-primary">Create User</button>
  </form>
</div>

<!-- Password Management -->
<div class="card">
  <div class="card-header"><h3>Password Management</h3></div>

  <div style="padding:16px;">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Change My Password</h4>
    <form method="POST" style="display:grid;grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:18px;">
      <input type="hidden" name="form_type" value="password_self">
      <div class="form-group" style="margin:0;">
        <label>Current Password</label>
        <input type="password" name="current_password" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>New Password</label>
        <input type="password" name="new_password" minlength="8" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>Confirm New Password</label>
        <input type="password" name="confirm_password" minlength="8" required>
      </div>
      <button type="submit" class="btn btn-primary">Update</button>
    </form>

    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Set Password for a User</h4>
    <form method="POST" style="display:grid;grid-template-columns: 220px 1fr 1fr auto; gap:10px; align-items:end;">
      <input type="hidden" name="form_type" value="password_user">
      <div class="form-group" style="margin:0;">
        <label>User</label>
        <select name="user_id" required>
          <option value="">Select user...</option>
          {% for u in users %}
            <option value="{{ u.id }}">{{ u.display_name }} ({{ u.username }}){% if not u.is_active_user %} — disabled{% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group" style="margin:0;">
        <label>New Password</label>
        <input type="password" name="new_password" minlength="8" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>Confirm New Password</label>
        <input type="password" name="confirm_password" minlength="8" required>
      </div>
      <button type="submit" class="btn btn-secondary" onclick="return confirm('Set a new password for this user?');">Set Password</button>
    </form>
    <div class="text-sm" style="color:var(--text-muted); margin-top:8px;">
      Passwords must be at least 8 characters. Password changes are audited, but passwords are never stored in audit logs.
    </div>
  </div>
</div>

<!-- Field Intake -->
<div class="card">
  <div class="card-header"><h3>Field Intake (Mobile Links + Submissions)</h3></div>
  <div style="padding:16px;">
    {% if last_field_link %}
    <div class="card" style="padding:14px 16px; margin-bottom:14px; border-color: rgba(34, 197, 94, 0.25);">
      <div style="font-weight:600;">New field link ready to share</div>
      <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
        This link is only shown once. If you lose it, create a new token.
      </div>

      <div class="form-group" style="margin-top:10px;">
        <label>Field Link</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="field-link" type="text" value="{{ last_field_link }}" readonly class="text-mono" style="flex:1;">
          <button type="button" class="btn btn-secondary btn-sm" onclick="copyText('field-link')">Copy link</button>
        </div>
      </div>

      <div class="form-row-3" style="margin-top:6px;">
        <div class="form-group" style="grid-column: span 3; margin:0;">
          <label>SMS share text</label>
          <div style="display:flex; gap:8px; align-items:flex-start;">
            <textarea id="field-sms" rows="2" readonly style="flex:1;">{{ last_field_sms }}</textarea>
            <button type="button" class="btn btn-secondary btn-sm" onclick="copyText('field-sms')">Copy SMS</button>
          </div>
        </div>
      </div>

      <div class="form-row-3" style="margin-top:6px;">
        <div class="form-group" style="grid-column: span 3; margin:0;">
          <label>Email subject</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="field-email-subject" type="text" value="{{ last_field_email_subject }}" readonly style="flex:1;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="copyText('field-email-subject')">Copy subject</button>
          </div>
        </div>
        <div class="form-group" style="grid-column: span 3; margin:0;">
          <label>Email body</label>
          <div style="display:flex; gap:8px; align-items:flex-start;">
            <textarea id="field-email-body" rows="4" readonly style="flex:1;">{{ last_field_email_body }}</textarea>
            <button type="button" class="btn btn-secondary btn-sm" onclick="copyText('field-email-body')">Copy body</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Create Field Access Link</h4>
    <form method="POST" action="{{ url_for('field_token_create') }}" style="display:grid;grid-template-columns: 1fr 140px auto; gap:10px; align-items:end; margin-bottom:14px;">
      <div class="form-group" style="margin:0;">
        <label>Label</label>
        <input type="text" name="label" placeholder="e.g. Field Purchasers (SMS link)" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>Expires (days)</label>
        <input type="number" name="expires_days" value="30" min="1" max="365" required>
      </div>
      <button type="submit" class="btn btn-primary">Create Link</button>
    </form>
    <div class="text-sm" style="color:var(--text-muted); margin-bottom:16px;">
      After creating a link, copy it from the green success message and send via SMS or email. Tokens are revocable.
    </div>

    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Active / Recent Tokens</h4>
    <div class="table-wrap mb-2">
      <table>
        <thead>
          <tr><th>Label</th><th>Status</th><th>Expires</th><th>Last Used</th><th></th></tr>
        </thead>
        <tbody>
          {% for t in field_tokens %}
          <tr>
            <td><strong>{{ t.label }}</strong></td>
            <td>
              {% if t.revoked_at %}
                <span class="badge badge-gray">Revoked</span>
              {% elif t.expires_at and t.expires_at < server_now %}
                <span class="badge badge-gray">Expired</span>
              {% else %}
                <span class="badge badge-green">Active</span>
              {% endif %}
            </td>
            <td>{{ t.expires_at.strftime('%m/%d/%y') if t.expires_at else '—' }}</td>
            <td>{{ t.last_used_at.strftime('%m/%d/%y %H:%M') if t.last_used_at else '—' }}</td>
            <td>
              {% if not t.revoked_at %}
              <form method="POST" action="{{ url_for('field_token_revoke', token_id=t.id) }}" style="display:inline;" onsubmit="return confirm('Revoke this token? Existing links will stop working.');">
                <button type="submit" class="btn btn-danger btn-sm">Revoke</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center cell-muted" style="padding:20px;">No field tokens created yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:18px 0 12px;">Pending Purchase Submissions</h4>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Submitted</th>
            <th>Supplier</th>
            <th class="text-right">Lots</th>
            <th class="text-right">$/lb</th>
            <th class="text-right">Potency %</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in field_submissions %}
          <tr>
            <td>{{ s.submitted_at.strftime('%m/%d/%y %H:%M') if s.submitted_at else '—' }}</td>
            <td><strong>{{ s.supplier.name if s.supplier else '—' }}</strong></td>
            <td class="text-right text-mono">{{ s.lots_count }}</td>
            <td class="text-right text-mono">{{ "${:,.2f}".format(s.price_per_lb) if s.price_per_lb else '—' }}</td>
            <td class="text-right text-mono">{{ "{:.1f}".format(s.estimated_potency_pct) if s.estimated_potency_pct else '—' }}</td>
            <td>
              {% if s.status == 'pending' %}<span class="badge badge-yellow">Pending</span>
              {% elif s.status == 'approved' %}<span class="badge badge-green">Approved</span>
              {% else %}<span class="badge badge-gray">Rejected</span>{% endif %}
            </td>
            <td style="white-space:nowrap;">
              {% if s.status == 'pending' %}
                <form method="POST" action="{{ url_for('field_submission_approve', submission_id=s.id) }}" style="display:inline;" onsubmit="return confirm('Approve this submission and create a Purchase?');">
                  <button type="submit" class="btn btn-primary btn-sm">Approve</button>
                </form>
                <form method="POST" action="{{ url_for('field_submission_reject', submission_id=s.id) }}" style="display:inline;" onsubmit="return confirm('Reject this submission?');">
                  <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                </form>
              {% elif s.approved_purchase %}
                <a href="{{ url_for('purchase_edit', purchase_id=s.approved_purchase.id) }}" class="btn btn-secondary btn-sm">View Purchase</a>
              {% else %}
                <span class="text-sm" style="color:var(--text-muted);">—</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center cell-muted" style="padding:20px;">No submissions yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Maintenance -->
<div class="card">
  <div class="card-header"><h3>Maintenance</h3></div>
  <div style="background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);padding:16px;">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Recalculate Run Costs</h4>
    <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:12px;">
      Recomputes <strong>Cost/Gram</strong> for all historical runs using current biomass pricing and Cost Entries allocation.
      Use this after entering new costs or updating cost logic.
    </p>
    <form method="POST" action="{{ url_for('settings_recalculate_costs') }}"
          onsubmit="return confirm('Recalculate cost-per-gram for ALL runs? This may take a moment.');">
      <button type="submit" class="btn btn-secondary btn-sm">Recalculate All Run Costs</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function copyText(elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const value = el.value || el.textContent || '';
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(value);
      return;
    }
    // Fallback
    el.focus();
    el.select && el.select();
    try { document.execCommand('copy'); } catch (e) {}
  }
</script>
{% endblock %}
