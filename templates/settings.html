{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="page-header">
  <h2>System Settings</h2>
</div>

<!-- System Settings -->
<div class="card">
  <div class="card-header"><h3>Operational Parameters</h3></div>
  <form method="POST">
    <input type="hidden" name="form_type" value="system">
    <div class="form-row-3">
      <div class="form-group">
        <label>Potency Rate ($/lb/%pt)</label>
        <input type="number" name="potency_rate" value="{{ system_settings.get('potency_rate', '1.50') }}" step="0.01">
      </div>
      <div class="form-group">
        <label>Number of Reactors</label>
        <input type="number" name="num_reactors" value="{{ system_settings.get('num_reactors', '2') }}">
      </div>
      <div class="form-group">
        <label>Reactor Capacity (lbs)</label>
        <input type="number" name="reactor_capacity" value="{{ system_settings.get('reactor_capacity', '100') }}">
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label>Runs Per Day Target</label>
        <input type="number" name="runs_per_day" value="{{ system_settings.get('runs_per_day', '5') }}">
      </div>
      <div class="form-group">
        <label>Operating Days/Week</label>
        <input type="number" name="operating_days" value="{{ system_settings.get('operating_days', '7') }}">
      </div>
      <div class="form-group">
        <label>Daily Throughput Target (lbs)</label>
        <input type="number" name="daily_throughput_target" value="{{ system_settings.get('daily_throughput_target', '500') }}">
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label>Weekly Throughput Target (lbs)</label>
        <input type="number" name="weekly_throughput_target" value="{{ system_settings.get('weekly_throughput_target', '3500') }}">
      </div>
    </div>
    <div class="form-group" style="margin-top:8px;">
      <label style="display:flex;align-items:center;gap:8px; text-transform:none; letter-spacing:0; font-size:0.85rem; color:var(--text-secondary);">
        <input type="checkbox" name="exclude_unpriced_batches" {% if system_settings.get('exclude_unpriced_batches', '0') in ('1','true','yes','on') %}checked{% endif %}>
        Exclude runs missing biomass pricing ($/lb) from yield + cost analytics
      </label>
      <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
        When enabled, Dashboard/Supplier/Strain KPIs ignore runs that are unlinked or have any input lot without a Purchase price.
      </div>
    </div>
    <div class="form-group" style="margin-top:10px;">
      <label>Cost Allocation Method (THCA vs HTE)</label>
      {% set method = system_settings.get('cost_allocation_method', 'per_gram_uniform') %}
      <select name="cost_allocation_method">
        <option value="per_gram_uniform" {% if method == 'per_gram_uniform' %}selected{% endif %}>
          Uniform $/g across all dry grams (THCA and HTE match)
        </option>
        <option value="split_50_50" {% if method == 'split_50_50' %}selected{% endif %}>
          Split total run cost 50/50 between THCA and HTE (lower yield → higher $/g)
        </option>
        <option value="custom_split" {% if method == 'custom_split' %}selected{% endif %}>
          Custom split of total run cost (set THCA % below)
        </option>
      </select>
      <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
        This impacts <strong>Cost/Gram THCA</strong> and <strong>Cost/Gram HTE</strong>. Combined $/g is always total cost ÷ total dry grams.
      </div>
    </div>
    <div class="form-row-3" style="margin-top:8px;">
      <div class="form-group">
        <label>Custom split — THCA % of total cost</label>
        <input type="number" name="cost_allocation_thca_pct" value="{{ system_settings.get('cost_allocation_thca_pct', '50') }}" step="0.1" min="0" max="100">
        <div class="text-sm" style="color:var(--text-muted); margin-top:4px;">
          Used only when “Custom split” is selected. HTE gets the remainder \(100 - \text{THCA%}\).
        </div>
      </div>
      <div class="form-group"></div>
      <div class="form-group"></div>
    </div>
    <div class="form-actions" style="border:none;padding:0;margin:0;">
      <button type="submit" class="btn btn-primary">Save Settings</button>
    </div>
  </form>
</div>

<!-- KPI Targets -->
<div class="card">
  <div class="card-header"><h3>KPI Targets</h3></div>
  <form method="POST">
    <input type="hidden" name="form_type" value="kpi">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>KPI</th>
            <th>Direction</th>
            <th>Unit</th>
            <th class="text-right">Target</th>
            <th class="text-right">Green Threshold</th>
            <th class="text-right">Yellow Threshold</th>
          </tr>
        </thead>
        <tbody>
          {% for kpi in kpis %}
          <tr>
            <input type="hidden" name="kpi_ids[]" value="{{ kpi.id }}">
            <td><strong>{{ kpi.display_name }}</strong></td>
            <td><span class="badge badge-gray">{{ kpi.direction.replace('_', ' ') }}</span></td>
            <td>{{ kpi.unit }}</td>
            <td class="text-right">
              <input type="number" name="target_{{ kpi.id }}" value="{{ kpi.target_value }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--text-primary);text-align:right;font-family:var(--font-mono);">
            </td>
            <td class="text-right">
              <input type="number" name="green_{{ kpi.id }}" value="{{ kpi.green_threshold }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--green);text-align:right;font-family:var(--font-mono);">
            </td>
            <td class="text-right">
              <input type="number" name="yellow_{{ kpi.id }}" value="{{ kpi.yellow_threshold }}" step="0.01"
                     style="width:80px;padding:4px 8px;background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);color:var(--yellow);text-align:right;font-family:var(--font-mono);">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="form-actions" style="border:none;padding-top:12px;margin:0;">
      <button type="submit" class="btn btn-primary">Save KPI Targets</button>
    </div>
  </form>
</div>

<!-- User Management -->
<div class="card">
  <div class="card-header"><h3>Users</h3></div>
  <div class="table-wrap mb-2">
    <table>
      <thead>
        <tr><th>Username</th><th>Display Name</th><th>Role</th><th>Status</th><th>Created</th><th></th></tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.display_name }}</td>
          <td><span class="badge badge-gold">{{ u.role.replace('_', ' ') }}</span></td>
          <td>
            {% if u.is_active_user %}
              <span class="badge badge-green">Active</span>
            {% else %}
              <span class="badge badge-gray">Disabled</span>
            {% endif %}
          </td>
          <td>{{ u.created_at.strftime('%m/%d/%y') if u.created_at else '—' }}</td>
          <td style="white-space:nowrap;">
            {% if u.id == current_user.id %}
              <span class="text-sm" style="color:var(--text-muted);">Current</span>
            {% else %}
              <form method="POST" action="{{ url_for('user_toggle_active', user_id=u.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure? This will {{ 'disable' if u.is_active_user else 'activate' }} the user account.');">
                {% if u.is_active_user %}
                  <button type="submit" class="btn btn-danger btn-sm">Disable</button>
                {% else %}
                  <button type="submit" class="btn btn-secondary btn-sm">Activate</button>
                {% endif %}
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form method="POST">
    <input type="hidden" name="form_type" value="user">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:16px 0 12px;">Add New User</h4>
    <div class="form-row-3">
      <div class="form-group">
        <label>Username</label>
        <input type="text" name="new_username" placeholder="lowercase, no spaces">
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" name="new_display" placeholder="Full name">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select name="new_role">
          <option value="viewer">Viewer (read only)</option>
          <option value="user">User (can edit data)</option>
          <option value="super_admin">Super Admin (full access)</option>
        </select>
      </div>
    </div>
    <div class="form-group" style="max-width:300px;">
      <label>Password</label>
      <input type="password" name="new_password" placeholder="Min 8 characters">
    </div>
    <button type="submit" class="btn btn-primary">Create User</button>
  </form>
</div>

<!-- Password Management -->
<div class="card">
  <div class="card-header"><h3>Password Management</h3></div>

  <div style="padding:16px;">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Change My Password</h4>
    <form method="POST" style="display:grid;grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:18px;">
      <input type="hidden" name="form_type" value="password_self">
      <div class="form-group" style="margin:0;">
        <label>Current Password</label>
        <input type="password" name="current_password" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>New Password</label>
        <input type="password" name="new_password" minlength="8" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>Confirm New Password</label>
        <input type="password" name="confirm_password" minlength="8" required>
      </div>
      <button type="submit" class="btn btn-primary">Update</button>
    </form>

    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;">Set Password for a User</h4>
    <form method="POST" style="display:grid;grid-template-columns: 220px 1fr 1fr auto; gap:10px; align-items:end;">
      <input type="hidden" name="form_type" value="password_user">
      <div class="form-group" style="margin:0;">
        <label>User</label>
        <select name="user_id" required>
          <option value="">Select user...</option>
          {% for u in users %}
            <option value="{{ u.id }}">{{ u.display_name }} ({{ u.username }}){% if not u.is_active_user %} — disabled{% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group" style="margin:0;">
        <label>New Password</label>
        <input type="password" name="new_password" minlength="8" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label>Confirm New Password</label>
        <input type="password" name="confirm_password" minlength="8" required>
      </div>
      <button type="submit" class="btn btn-secondary" onclick="return confirm('Set a new password for this user?');">Set Password</button>
    </form>
    <div class="text-sm" style="color:var(--text-muted); margin-top:8px;">
      Passwords must be at least 8 characters. Password changes are audited, but passwords are never stored in audit logs.
    </div>
  </div>
</div>

<!-- Maintenance -->
<div class="card">
  <div class="card-header"><h3>Maintenance</h3></div>
  <div style="background:var(--dark);border:1px solid var(--dark-border);border-radius:var(--radius);padding:16px;">
    <h4 style="color:var(--gold);font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Recalculate Run Costs</h4>
    <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:12px;">
      Recomputes <strong>Cost/Gram</strong> for all historical runs using current biomass pricing and Cost Entries allocation.
      Use this after entering new costs or updating cost logic.
    </p>
    <form method="POST" action="{{ url_for('settings_recalculate_costs') }}"
          onsubmit="return confirm('Recalculate cost-per-gram for ALL runs? This may take a moment.');">
      <button type="submit" class="btn btn-secondary btn-sm">Recalculate All Run Costs</button>
    </form>
  </div>
</div>
{% endblock %}
